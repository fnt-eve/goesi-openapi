#!/bin/bash
set -e

OUTPUT="ratelimit/mapping.go"

echo "Generating $OUTPUT..."

cat > $OUTPUT <<EOF
package ratelimit

// This file is generated by scripts/generate_ratelimit_map.sh; DO NOT EDIT.

import (
	"regexp"
	"time"
)

type RouteConfig struct {
	Method    string
	PathRegex *regexp.Regexp
	Group     string
	Limit     int
	Window    time.Duration
	Auth      bool
}

var RouteMapping = []RouteConfig{
EOF

# Extract routes with rate limits
# 1. Iterate paths and methods
# 2. Select operations with x-rate-limit
# 3. Format as Go struct
# regex replacement: {param} -> [^/]+
# window parsing: assume "15m" -> 15 * time.Minute
jq -r '
.paths | to_entries[] | 
.key as $path | 
.value | to_entries[] | 
.key as $method | 
select(.value."x-rate-limit") | 
{
  method: ($method | ascii_upcase),
  path: $path, 
  group: .value."x-rate-limit".group, 
  limit: .value."x-rate-limit"."max-tokens", 
  window: .value."x-rate-limit"."window-size",
  auth: (if .value.security then (.value.security | any(has("OAuth2"))) else false end)
} | 
"    {
        Method: \"\(.method)\",
        PathRegex: regexp.MustCompile(`^\($path | sub("\\{[^}]+\\}"; "[^/]+"; "g"))/?$`),
        Group: \"\(.group)\",
        Limit: \(.limit),
        Window: \(.window | if endswith("m") then "\(. | rtrimstr("m")) * time.Minute" elif endswith("h") then "\(. | rtrimstr("h")) * time.Hour" elif endswith("s") then "\(. | rtrimstr("s")) * time.Second" else "15 * time.Minute" end),
        Auth: \(.auth),
    },"
' esi-openapi-spec.json >> $OUTPUT

echo "}" >> $OUTPUT
gofmt -w $OUTPUT

echo "Done."
