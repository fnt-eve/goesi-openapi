#!/bin/sh

# This script generates scopes.go from esi-openapi-spec.json

set -e

SPEC_FILE="esi-openapi-spec.json"
OUTPUT_FILE="scopes.go"

echo "Generating ${OUTPUT_FILE} from ${SPEC_FILE}..."

# Start the Go file content
cat > ${OUTPUT_FILE} << EOL
package goesi

// This file is generated by generate_scopes.sh. DO NOT EDIT.

const (
EOL

# Extract scopes and append to the Go file
jq -r '.components.securitySchemes.OAuth2.flows.authorizationCode.scopes | keys[]' ${SPEC_FILE} | while read scope; do
    # Create a constant name from the scope string
    # Remove esi- prefix, split on dots, dashes, and underscores, then capitalize each part
    const_name=$(echo ${scope} | sed 's/^esi-//' | sed 's/[._-]/ /g' | awk '{
        result = ""
        for(i=1; i<=NF; i++) {
            word = $i
            # Handle version numbers specially (v1 -> V1)
            if(word ~ /^v[0-9]+$/) {
                word = toupper(substr(word, 1, 1)) substr(word, 2)
            } else {
                # Capitalize first letter, keep rest as is
                word = toupper(substr(word, 1, 1)) substr(word, 2)
            }
            result = result word
        }
        print result
    }')
    echo "    Scope${const_name} = \"${scope}\"" >> ${OUTPUT_FILE}
done

# End the constants section
echo ")" >> ${OUTPUT_FILE}

echo "Successfully generated ${OUTPUT_FILE}."
